---
# Kubernetes Deployment for NER service with volume-mounted models
# 
# This deployment expects:
#  - PersistentVolumeClaim "ner-models-pvc" in sentineltranslate namespace
#  - Container image "ner-service:latest" available to cluster
#  - Namespace "sentineltranslate" exists
#
# Usage:
#   # Create namespace first
#   kubectl create namespace sentineltranslate
#   
#   # Create PVC for models
#   kubectl apply -f k8s/pvc.yaml
#   
#   # Deploy service
#   kubectl apply -f k8s/deployment.yaml
#   
#   # Check status
#   kubectl -n sentineltranslate get pods -l app=ner-service
#   kubectl -n sentineltranslate logs deployment/ner-service

apiVersion: apps/v1
kind: Deployment
metadata:
  name: ner-service
  namespace: sentineltranslate
  labels:
    app: ner-service
    version: "1.0"
spec:
  replicas: 2  # Run 2 instances for availability (share PVC for read-only models)
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # Maintain availability during rolling updates
  selector:
    matchLabels:
      app: ner-service
  template:
    metadata:
      labels:
        app: ner-service
        version: "1.0"
      annotations:
        description: "NER microservice with volume-mounted models"
    spec:
      # Pod scheduling constraints
      affinity:
        # Prefer spreading pods across different nodes
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - ner-service
                topologyKey: kubernetes.io/hostname
      
      # Service account (optional - for future RBAC)
      serviceAccountName: default
      
      # Security context for the pod
      securityContext:
        fsGroup: 1001  # UBI Python image runs as UID 1001
      
      # Containers
      containers:
        - name: ner-service
          image: ner-service:latest
          imagePullPolicy: IfNotPresent  # Use local image first
          
          # Port exposed
          ports:
            - name: http
              containerPort: 8081
              protocol: TCP
          
          # Environment variables
          env:
            # NER service configuration
            - name: NER_FRAMEWORK
              value: "both"  # spacy, stanza, or both
            - name: SPACY_MODEL_PATH
              value: "/app/models/spacy"
            - name: STANZA_MODEL_PATH
              value: "/app/models/stanza"
            - name: NER_FALLBACK_MODE
              value: "multilingual"
            
            # Python settings
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: PYTHONDONTWRITEBYTECODE
              value: "1"
            
            # Logging
            - name: LOG_LEVEL
              value: "INFO"
          
          # Volume mounts
          volumeMounts:
            # Mount models as read-only
            - name: ner-models
              mountPath: /app/models
              readOnly: true
          
          # Resource requests and limits
          resources:
            # Minimum resources required
            requests:
              cpu: 500m        # 0.5 CPU
              memory: 2Gi      # 2GB RAM
            # Maximum resources allowed
            limits:
              cpu: 2000m       # 2 CPUs
              memory: 4Gi      # 4GB RAM
          
          # Liveness probe - restarts container if unhealthy
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 40  # Wait for startup
            periodSeconds: 30         # Check every 30s
            timeoutSeconds: 10
            failureThreshold: 3
          
          # Readiness probe - removes from load balancer if not ready
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          # Startup probe - handles slow startups (optional)
          startupProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 30  # 5 minutes total timeout
          
          # Security context for the container
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false  # Need RW for spaCy cache
            capabilities:
              drop:
                - ALL
      
      # Volumes
      volumes:
        # Models volume from PVC (read-only)
        - name: ner-models
          persistentVolumeClaim:
            claimName: ner-models-pvc
            readOnly: true

---
# HorizontalPodAutoscaler for NER service
# Automatically scales pods based on CPU and memory usage
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ner-service-hpa
  namespace: sentineltranslate
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ner-service
  minReplicas: 2  # Minimum replicas
  maxReplicas: 5  # Maximum replicas
  metrics:
    # Scale based on CPU usage
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    # Scale based on memory usage
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
